"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("vue"),d=require("@reevit/core");function X(t){const s=t.toLowerCase();return s.includes("paystack")?"paystack":s.includes("hubtel")?"hubtel":s.includes("flutterwave")?"flutterwave":"paystack"}function Z(t,s){return{id:t.id,clientSecret:t.client_secret,pspPublicKey:t.psp_public_key,amount:t.amount,currency:t.currency,status:t.status,recommendedPsp:X(t.provider),availableMethods:s.paymentMethods||["card","mobile_money"],reference:t.reference||s.reference,connectionId:t.connection_id,provider:t.provider,feeAmount:t.fee_amount,feeCurrency:t.fee_currency,netAmount:t.net_amount,metadata:s.metadata}}function F(t){const{config:s,onSuccess:n,onError:i,onClose:p,onStateChange:l,apiBaseUrl:u}=t,a=e.ref(d.createInitialState());if(s.initialPaymentIntent){const r=s.initialPaymentIntent;a.value={...a.value,status:"ready",paymentIntent:r,selectedMethod:r.availableMethods?.length===1?r.availableMethods[0]:null}}const b=new d.ReevitAPIClient({publicKey:s.publicKey,baseUrl:u}),m=r=>{a.value=d.reevitReducer(a.value,r)};e.watch(()=>a.value.status,r=>{l?.(r)});const y=async r=>{m({type:"INIT_START"});try{const o=s.reference||d.generateReference(),c=d.detectCountryFromCurrency(s.currency),E=r||s.paymentMethods?.[0]||"card",{data:f,error:O}=await b.createPaymentIntent({...s,reference:o},E,c);if(O){m({type:"INIT_ERROR",payload:O}),i?.(O);return}if(!f){const $={code:"INIT_FAILED",message:"No data received from API",recoverable:!0};m({type:"INIT_ERROR",payload:$}),i?.($);return}const W=Z(f,{...s,reference:o});m({type:"INIT_SUCCESS",payload:W})}catch(o){const c={code:"INIT_FAILED",message:o instanceof Error?o.message:"Failed to initialize checkout",recoverable:!0,originalError:o};m({type:"INIT_ERROR",payload:c}),i?.(c)}},h=r=>{m({type:"SELECT_METHOD",payload:r})},k=async r=>{if(!(!a.value.paymentIntent||!a.value.selectedMethod)){m({type:"PROCESS_START"});try{let o;if(a.value.paymentIntent.clientSecret){const{data:E,error:f}=await b.confirmPaymentIntent(a.value.paymentIntent.id,a.value.paymentIntent.clientSecret);if(f){m({type:"PROCESS_ERROR",payload:f}),i?.(f);return}o=E}else{const{data:E,error:f}=await b.confirmPayment(a.value.paymentIntent.id);if(f){m({type:"PROCESS_ERROR",payload:f}),i?.(f);return}o=E}const c={paymentId:a.value.paymentIntent.id,reference:r.reference||a.value.paymentIntent.reference||a.value.paymentIntent.metadata?.reference||"",amount:a.value.paymentIntent.amount,currency:a.value.paymentIntent.currency,paymentMethod:a.value.selectedMethod,psp:a.value.paymentIntent.recommendedPsp,pspReference:r.pspReference||o?.provider_ref_id||"",status:"success",metadata:r};m({type:"PROCESS_SUCCESS",payload:c}),n?.(c)}catch(o){const c={code:"PAYMENT_FAILED",message:o instanceof Error?o.message:"Payment failed",recoverable:!0,originalError:o};m({type:"PROCESS_ERROR",payload:c}),i?.(c)}}},S=async r=>{await k(r)},V=r=>{m({type:"PROCESS_ERROR",payload:r}),i?.(r)},P=()=>{m({type:"RESET"})},M=async()=>{if(a.value.paymentIntent&&a.value.status!=="success")try{await b.cancelPaymentIntent(a.value.paymentIntent.id)}catch{}m({type:"CLOSE"}),p?.()},w=e.computed(()=>a.value.status),B=e.computed(()=>a.value.paymentIntent),C=e.computed(()=>a.value.selectedMethod),g=e.computed(()=>a.value.error),v=e.computed(()=>a.value.result),R=e.computed(()=>a.value.status==="loading"||a.value.status==="processing"),_=e.computed(()=>a.value.status==="ready"||a.value.status==="method_selected"||a.value.status==="processing"),N=e.computed(()=>a.value.status==="success"),T=e.computed(()=>a.value.error?.recoverable??!1);return{status:e.readonly(w),paymentIntent:e.readonly(B),selectedMethod:e.readonly(C),error:e.readonly(g),result:e.readonly(v),initialize:y,selectMethod:h,processPayment:k,handlePspSuccess:S,handlePspError:V,reset:P,close:M,isLoading:e.readonly(R),isReady:e.readonly(_),isComplete:e.readonly(N),canRetry:e.readonly(T)}}const ee={class:"reevit-method-selector"},te={class:"reevit-amount-display"},ne={class:"reevit-methods-grid"},oe=["onClick"],ae={class:"reevit-method-icon"},re={class:"reevit-method-info"},se={class:"reevit-method-name"},le={class:"reevit-method-description"},ce={class:"reevit-method-radio"},ie={key:0,class:"reevit-radio-inner"},K=e.defineComponent({__name:"PaymentMethodSelector",props:{methods:{},selected:{},amount:{},currency:{}},emits:["select"],setup(t,{emit:s}){const n=t,i=s,p=e.computed(()=>[{id:"card",name:"Card",description:"Visa, Mastercard, Maestro",icon:"ðŸ’³"},{id:"mobile_money",name:"Mobile Money",description:"MTN, Vodafone, AirtelTigo",icon:"ðŸ“±"},{id:"bank_transfer",name:"Bank Transfer",description:"Transfer directly from your bank",icon:"ðŸ¦"}].filter(l=>n.methods.includes(l.id)));return(l,u)=>(e.openBlock(),e.createElementBlock("div",ee,[u[0]||(u[0]=e.createElementVNode("h3",{class:"reevit-section-title"},"Select Payment Method",-1)),e.createElementVNode("p",te," Pay "+e.toDisplayString(e.unref(d.formatAmount)(t.amount,t.currency)),1),e.createElementVNode("div",ne,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(p.value,a=>(e.openBlock(),e.createElementBlock("button",{key:a.id,type:"button",class:e.normalizeClass(e.unref(d.cn)("reevit-method-card",t.selected===a.id&&"reevit-method-card--selected")),onClick:b=>i("select",a.id)},[e.createElementVNode("span",ae,e.toDisplayString(a.icon),1),e.createElementVNode("div",re,[e.createElementVNode("span",se,e.toDisplayString(a.name),1),e.createElementVNode("span",le,e.toDisplayString(a.description),1)]),e.createElementVNode("div",ce,[t.selected===a.id?(e.openBlock(),e.createElementBlock("div",ie)):e.createCommentVNode("",!0)])],10,oe))),128))])]))}}),ue={class:"reevit-form-group"},de=["disabled"],me={class:"reevit-network-selector"},pe={class:"reevit-networks-grid"},ye=["onClick","disabled"],ve={key:0,class:"reevit-error-message"},he=["disabled"],fe={key:0,class:"reevit-spinner"},be={key:1},j=e.defineComponent({__name:"MobileMoneyForm",props:{initialPhone:{},loading:{type:Boolean}},emits:["submit"],setup(t,{emit:s}){const n=t,i=s,p=e.ref(n.initialPhone||""),l=e.ref(null),u=e.ref(null);e.watch(p,m=>{const y=d.detectNetwork(m);y&&(l.value=y),u.value&&(u.value=null)});const a=()=>{if(!d.validatePhone(p.value)){u.value="Please enter a valid phone number";return}if(!l.value){u.value="Please select your mobile network";return}i("submit",{phone:p.value,network:l.value})},b=[{id:"mtn",name:"MTN",color:"#FFCC00"},{id:"vodafone",name:"Vodafone",color:"#E60000"},{id:"airteltigo",name:"AirtelTigo",color:"#005596"}];return(m,y)=>(e.openBlock(),e.createElementBlock("form",{class:"reevit-momo-form",onSubmit:e.withModifiers(a,["prevent"])},[e.createElementVNode("div",ue,[y[1]||(y[1]=e.createElementVNode("label",{class:"reevit-label",for:"reevit-phone"},"Phone Number",-1)),e.withDirectives(e.createElementVNode("input",{id:"reevit-phone","onUpdate:modelValue":y[0]||(y[0]=h=>p.value=h),type:"tel",class:e.normalizeClass(["reevit-input",{"reevit-input--error":u.value&&!e.unref(d.validatePhone)(p.value)}]),placeholder:"e.g. 024 123 4567",disabled:t.loading,autocomplete:"tel"},null,10,de),[[e.vModelText,p.value]])]),e.createElementVNode("div",me,[y[2]||(y[2]=e.createElementVNode("label",{class:"reevit-label"},"Select Network",-1)),e.createElementVNode("div",pe,[(e.openBlock(),e.createElementBlock(e.Fragment,null,e.renderList(b,h=>e.createElementVNode("button",{key:h.id,type:"button",class:e.normalizeClass(e.unref(d.cn)("reevit-network-btn",l.value===h.id&&"reevit-network-btn--selected")),onClick:k=>l.value=h.id,disabled:t.loading},[e.createElementVNode("div",{class:"reevit-network-dot",style:e.normalizeStyle({backgroundColor:h.color})},null,4),e.createTextVNode(" "+e.toDisplayString(h.name),1)],10,ye)),64))])]),u.value?(e.openBlock(),e.createElementBlock("p",ve,e.toDisplayString(u.value),1)):e.createCommentVNode("",!0),e.createElementVNode("button",{type:"submit",class:"reevit-submit-btn",disabled:t.loading||!p.value},[t.loading?(e.openBlock(),e.createElementBlock("span",fe)):(e.openBlock(),e.createElementBlock("span",be,"Continue"))],8,he),y[3]||(y[3]=e.createElementVNode("p",{class:"reevit-secure-text"}," ðŸ”’ Secure mobile money payment via Reevit ",-1))],32))}}),D=new Map;function I(t,s){const n=D.get(s);if(n)return n;const i=new Promise((p,l)=>{if(document.getElementById(s)){p();return}const u=document.createElement("script");u.id=s,u.src=t,u.async=!0,u.onload=()=>p(),u.onerror=()=>l(new Error(`Failed to load ${s} script`)),document.head.appendChild(u)});return D.set(s,i),i}function A(){return I("https://js.paystack.co/v1/inline.js","paystack-script")}function L(){return I("https://checkout.hubtel.com/js/hubtel-checkout.js","hubtel-script")}function U(){return I("https://checkout.flutterwave.com/v3.js","flutterwave-script")}function z(){return I("https://js.stripe.com/v3/","stripe-script")}function x(){return I("https://sdk.monnify.com/plugin/monnify.js","monnify-script")}async function H(t){if(await A(),!window.PaystackPop)throw new Error("Paystack script not loaded");window.PaystackPop.setup({key:t.key,email:t.email,amount:t.amount,currency:t.currency,ref:t.ref,metadata:t.metadata,callback:t.onSuccess,onClose:t.onClose}).openIframe()}async function q(t){if(await L(),!window.HubtelCheckout)throw new Error("Hubtel script not loaded");window.HubtelCheckout.initPay({clientId:t.clientId,purchaseDescription:t.purchaseDescription,amount:t.amount,callbackUrl:t.callbackUrl,customerPhone:t.customerPhone,customerEmail:t.customerEmail,onSuccess:t.onSuccess,onClose:t.onClose})}async function Y(t){if(await U(),!window.FlutterwaveCheckout)throw new Error("Flutterwave script not loaded");window.FlutterwaveCheckout({public_key:t.public_key,tx_ref:t.tx_ref,amount:t.amount,currency:t.currency,customer:t.customer,payment_options:t.payment_options,customizations:t.customizations,callback:t.callback,onclose:t.onclose})}async function G(t){if(await z(),!window.Stripe)throw new Error("Stripe.js not loaded");return window.Stripe(t)}async function ke(t){const n=await(await G(t.publishableKey)).confirmPayment({elements:t.elements,clientSecret:t.clientSecret,redirect:"if_required"});n.error?t.onError({message:n.error.message||"Payment failed"}):n.paymentIntent&&t.onSuccess({paymentIntentId:n.paymentIntent.id,status:n.paymentIntent.status})}async function J(t){if(await x(),!window.MonnifySDK)throw new Error("Monnify SDK not loaded");window.MonnifySDK.initialize({amount:t.amount,currency:t.currency,reference:t.reference,customerName:t.customerName,customerEmail:t.customerEmail,customerMobileNumber:t.customerPhone,apiKey:t.apiKey,contractCode:t.contractCode,paymentDescription:t.paymentDescription||"Payment",isTestMode:t.isTestMode??!1,metadata:t.metadata,onComplete:s=>{s.status==="SUCCESS"?t.onSuccess({transactionReference:s.transactionReference,paymentReference:s.paymentReference,...s}):t.onError?.({message:s.message||"Payment failed"})},onClose:t.onClose})}async function Q(t,s){t.onInitiated();try{const n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone_number:t.phoneNumber,amount:t.amount,reference:t.reference,description:t.description})});if(!n.ok){const l=(await n.json().catch(()=>({}))).message||"Failed to initiate M-Pesa payment";return t.onError({message:l}),{status:"failed",message:l}}const i=await n.json();return{status:"initiated",message:"Please check your phone and enter your M-Pesa PIN to complete the payment.",transactionId:i.checkout_request_id||i.transaction_id}}catch(n){const i=n instanceof Error?n.message:"Network error";return t.onError({message:i}),{status:"failed",message:i}}}const Ee=["disabled"],Pe={key:0,class:"reevit-spinner"},Se={class:"reevit-modal-body"},we={key:0,class:"reevit-loading-state"},Ce={key:1,class:"reevit-error-state"},_e={key:2,class:"reevit-success-state"},Ne={key:1,class:"reevit-method-form-container"},Ie={key:2,class:"reevit-card-info"},Me=["disabled"],Re={key:0,class:"reevit-spinner"},Ve={key:1},Be=e.defineComponent({__name:"ReevitCheckout",props:{publicKey:{},amount:{},currency:{},email:{},phone:{},reference:{},metadata:{},paymentMethods:{},theme:{},isOpen:{type:Boolean},apiBaseUrl:{},initialPaymentIntent:{}},emits:["success","error","close"],setup(t,{emit:s}){const n=t,i=s,{status:p,paymentIntent:l,selectedMethod:u,error:a,isLoading:b,isReady:m,initialize:y,selectMethod:h,handlePspSuccess:k,handlePspError:S,close:V}=F({config:{publicKey:n.publicKey,amount:n.amount,currency:n.currency,email:n.email,phone:n.phone,reference:n.reference,metadata:n.metadata,paymentMethods:n.paymentMethods,initialPaymentIntent:n.initialPaymentIntent},apiBaseUrl:n.apiBaseUrl,onSuccess:r=>i("success",r),onError:r=>i("error",r),onClose:()=>i("close")}),P=e.ref(n.isOpen??!1);e.watch(()=>n.isOpen,r=>{r!==void 0&&(P.value=r)});const M=()=>{P.value=!0,!l.value&&p.value==="idle"&&y()};e.watch([P,l,u],([r,o,c])=>{r&&o&&c&&c==="card"&&C(null)});const w=()=>{P.value=!1,V()},B=r=>{h(r)},C=async r=>{if(!l.value)return;const o=l.value.recommendedPsp;try{if(o==="paystack")await H({key:n.publicKey,email:n.email||"",amount:n.amount,currency:n.currency,ref:l.value.id,onSuccess:c=>k(c),onClose:()=>{}});else if(o==="hubtel")await q({clientId:n.publicKey,purchaseDescription:`Payment for ${n.amount} ${n.currency}`,amount:n.amount,customerPhone:r?.phone||n.phone,customerEmail:n.email,onSuccess:c=>k(c),onClose:()=>{}});else if(o==="flutterwave")await Y({public_key:n.publicKey,tx_ref:l.value.id,amount:n.amount,currency:n.currency,customer:{email:n.email||"",phone_number:r?.phone||n.phone},callback:c=>k(c),onclose:()=>{}});else if(o==="monnify")await J({apiKey:l.value.pspPublicKey||n.publicKey,contractCode:n.metadata?.contract_code||n.publicKey,amount:n.amount,currency:n.currency,reference:l.value.reference||l.value.id,customerName:n.metadata?.customer_name||n.email||"",customerEmail:n.email||"",customerPhone:r?.phone||n.phone,metadata:n.metadata,onSuccess:c=>k(c),onClose:()=>{}});else if(o==="mpesa"){const c=`${n.apiBaseUrl||"https://api.reevit.io"}/v1/payments/${l.value.id}/mpesa`;await Q({phoneNumber:r?.phone||n.phone||"",amount:n.amount,reference:l.value.reference||l.value.id,description:`Payment ${l.value.reference||""}`,onInitiated:()=>{},onSuccess:E=>k(E),onError:E=>S({code:"MPESA_ERROR",message:E.message})},c)}else S(o==="stripe"?{code:"STRIPE_NOT_IMPLEMENTED",message:"Stripe integration requires custom Elements setup. Please use the React SDK or implement custom Stripe Elements."}:{code:"UNSUPPORTED_PSP",message:`Payment provider "${o}" is not supported in this checkout.`})}catch(c){S({code:"BRIDGE_ERROR",message:c instanceof Error?c.message:"Failed to open payment gateway"})}},g=e.computed(()=>d.createThemeVariables(n.theme||{}));e.watch(P,r=>{r?document.body.style.overflow="hidden":document.body.style.overflow=""}),e.onUnmounted(()=>{document.body.style.overflow=""});const v=e.computed(()=>p.value),R=e.computed(()=>a.value),_=e.computed(()=>u.value),N=e.computed(()=>b.value),T=e.computed(()=>m.value);return(r,o)=>(e.openBlock(),e.createElementBlock("div",{class:"reevit-sdk-container",style:e.normalizeStyle(g.value)},[e.renderSlot(r.$slots,"default",{open:M,isLoading:N.value},()=>[e.createElementVNode("button",{type:"button",class:"reevit-pay-button",onClick:M,disabled:N.value},[N.value?(e.openBlock(),e.createElementBlock("span",Pe)):e.renderSlot(r.$slots,"button-text",{key:1},()=>[o[1]||(o[1]=e.createTextVNode("Pay Now",-1))])],8,Ee)]),(e.openBlock(),e.createBlock(e.Teleport,{to:"body"},[P.value?(e.openBlock(),e.createElementBlock("div",{key:0,class:"reevit-modal-overlay",onClick:e.withModifiers(w,["self"])},[e.createElementVNode("div",{class:e.normalizeClass(["reevit-modal-content",{"reevit-modal--dark":n.theme?.darkMode}])},[e.createElementVNode("button",{class:"reevit-modal-close",onClick:w,"aria-label":"Close"}," Ã— "),o[9]||(o[9]=e.createElementVNode("div",{class:"reevit-modal-header"},[e.createElementVNode("img",{src:"https://i.imgur.com/bzUR5Lm.png",alt:"Reevit",class:"reevit-modal__logo"})],-1)),e.createElementVNode("div",Se,[v.value==="loading"?(e.openBlock(),e.createElementBlock("div",we,[...o[2]||(o[2]=[e.createElementVNode("div",{class:"reevit-spinner reevit-spinner--large"},null,-1),e.createElementVNode("p",null,"Initializing payment...",-1)])])):v.value==="failed"&&R.value?(e.openBlock(),e.createElementBlock("div",Ce,[o[3]||(o[3]=e.createElementVNode("div",{class:"reevit-error-icon"},"âš ï¸",-1)),o[4]||(o[4]=e.createElementVNode("h3",null,"Payment Failed",-1)),e.createElementVNode("p",null,e.toDisplayString(R.value.message),1),e.createElementVNode("button",{class:"reevit-retry-btn",onClick:o[0]||(o[0]=c=>e.unref(y)())},"Retry")])):v.value==="success"?(e.openBlock(),e.createElementBlock("div",_e,[o[5]||(o[5]=e.createElementVNode("div",{class:"reevit-success-icon"},"âœ…",-1)),o[6]||(o[6]=e.createElementVNode("h3",null,"Payment Successful",-1)),o[7]||(o[7]=e.createElementVNode("p",null,"Thank you for your payment.",-1)),e.createElementVNode("button",{class:"reevit-done-btn",onClick:w},"Done")])):T.value?(e.openBlock(),e.createElementBlock(e.Fragment,{key:3},[v.value==="ready"||v.value==="method_selected"||v.value==="processing"?(e.openBlock(),e.createBlock(K,{key:0,methods:n.paymentMethods||["card","mobile_money"],selected:_.value,amount:n.amount,currency:n.currency,onSelect:B},null,8,["methods","selected","amount","currency"])):e.createCommentVNode("",!0),(v.value==="method_selected"||v.value==="processing")&&_.value==="mobile_money"?(e.openBlock(),e.createElementBlock("div",Ne,[e.createVNode(j,{"initial-phone":n.phone,loading:v.value==="processing",onSubmit:C},null,8,["initial-phone","loading"])])):e.createCommentVNode("",!0),(v.value==="method_selected"||v.value==="processing")&&_.value==="card"?(e.openBlock(),e.createElementBlock("div",Ie,[o[8]||(o[8]=e.createElementVNode("p",{class:"reevit-info-text"},"You will be redirected to our secure payment partner to complete your card payment.",-1)),e.createElementVNode("button",{class:"reevit-submit-btn",onClick:C,disabled:v.value==="processing"},[v.value==="processing"?(e.openBlock(),e.createElementBlock("span",Re)):(e.openBlock(),e.createElementBlock("span",Ve,"Proceed to Card Payment"))],8,Me)])):e.createCommentVNode("",!0)],64)):e.createCommentVNode("",!0)]),o[10]||(o[10]=e.createElementVNode("div",{class:"reevit-modal-footer"},[e.createElementVNode("div",{class:"reevit-trust-badges"},[e.createElementVNode("span",null,"PCI DSS Compliant"),e.createElementVNode("span",null,"â€¢"),e.createElementVNode("span",null,"SSL Secure")])],-1))],2)])):e.createCommentVNode("",!0)]))],4))}});Object.defineProperty(exports,"ReevitAPIClient",{enumerable:!0,get:()=>d.ReevitAPIClient});Object.defineProperty(exports,"cn",{enumerable:!0,get:()=>d.cn});Object.defineProperty(exports,"createReevitClient",{enumerable:!0,get:()=>d.createReevitClient});Object.defineProperty(exports,"detectCountryFromCurrency",{enumerable:!0,get:()=>d.detectCountryFromCurrency});Object.defineProperty(exports,"detectNetwork",{enumerable:!0,get:()=>d.detectNetwork});Object.defineProperty(exports,"formatAmount",{enumerable:!0,get:()=>d.formatAmount});Object.defineProperty(exports,"formatPhone",{enumerable:!0,get:()=>d.formatPhone});Object.defineProperty(exports,"validatePhone",{enumerable:!0,get:()=>d.validatePhone});exports.MobileMoneyForm=j;exports.PaymentMethodSelector=K;exports.ReevitCheckout=Be;exports.confirmStripePayment=ke;exports.createStripeInstance=G;exports.initiateMPesaSTKPush=Q;exports.loadFlutterwaveScript=U;exports.loadHubtelScript=L;exports.loadMonnifyScript=x;exports.loadPaystackScript=A;exports.loadStripeScript=z;exports.openFlutterwaveModal=Y;exports.openHubtelPopup=q;exports.openMonnifyModal=J;exports.openPaystackPopup=H;exports.useReevit=F;
